{% extends "./base.html" %}

{% load static %}

{% block content %}
<main>
  <div class="album py-5 bg-light">
    <div class="container">

      <!-- Category Title -->
      <div class="pb-3 h5"> {{ category.name | capfirst }} </div>
      <hr>

      <!-- Search and Sorting -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <input id="search" type="text" class="form-control w-50" placeholder="Search products...">
        <select id="sort" class="form-select w-25 ms-3">
          <option value="name">Name</option>
          <option value="price">Price</option>
          <option value="-price">Price (highest first)</option>
          <option value="stock">Stock</option>
          <option value="-stock">Stock (highest first)</option>
        </select>
      </div>

      <!-- Products -->
      <div class="row row-cols-1 row-cols-sm-2 row-cols-md-5 g-3" id="product-list">
        {% for product in products.object_list %}
        <div class="col">
          <div class="card shadow-sm">
            {% if product.image %}
            <img class="img-fluid" alt="Responsive image" src="{{ product.image.url }}">
            {% else %}
            <img class="img-fluid" alt="No image available" src="{% static 'images/no-image.png' %}">
            {% endif %}

            <div class="card-body">
              <p class="card-text">
                <a class="text-info text-decoration-none" href="{{ product.get_absolute_url }}">{{ product.name }}</a>
              </p>
              <div class="d-flex justify-content-between align-items-center">
                <h5>$ {{ product.price }}</h5>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Pagination -->
      <div class="d-flex justify-content-center mt-4" id="pagination">
        {% if products.has_previous %}
        <button class="btn btn-outline-primary me-2" data-page="{{ products.previous_page_number }}">Previous</button>
        {% endif %}
        {% if products.has_next %}
        <button class="btn btn-outline-primary" data-page="{{ products.next_page_number }}">Next</button>
        {% endif %}
      </div>
    </div>
  </div>
</main>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  // Function to load products via Ajax
  function loadProducts(page = 1) {
    const query = $('#search').val();
    const sort_by = $('#sort').val();

    $.ajax({
      url: "?",
      data: { page, q: query, sort_by },
      success: function (data) {
        const productList = $('#product-list');
        productList.empty();

        data.products.forEach(product => {
          productList.append(`
            <div class="col">
              <div class="card shadow-sm">
                ${product.image ? `<img class="img-fluid" alt="Product image" src="${product.image}">` : `<img class="img-fluid" alt="No image available" src="{% static 'images/no-image.png' %}">`}
                <div class="card-body">
                  <p class="card-text">
                    <a class="text-info text-decoration-none" href="/product/${product.slug}">${product.name}</a>
                  </p>
                  <div class="d-flex justify-content-between align-items-center">
                    <h5>$ ${product.price}</h5>
                  </div>
                </div>
              </div>
            </div>
          `);
        });

        const pagination = $('#pagination');
        pagination.empty();

        if (data.has_previous) {
          pagination.append('<button class="btn btn-outline-primary me-2" data-page="' + (page - 1) + '">Previous</button>');
        }
        if (data.has_next) {
          pagination.append('<button class="btn btn-outline-primary" data-page="' + (page + 1) + '">Next</button>');
        }
      }
    });
  }

  // Event listeners for search, sorting, and pagination
  $(document).on('keyup', '#search', function () {
    loadProducts();
  });

  $(document).on('change', '#sort', function () {
    loadProducts();
  });

  $(document).on('click', '#pagination button', function () {
    const page = $(this).data('page');
    loadProducts(page);
  });
</script>
{% endblock %}
